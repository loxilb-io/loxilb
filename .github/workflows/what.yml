name: What-Sanity-CI

on:
  push:
    branches:
      - main
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'
      tags:
        description: 'What Sanity'
       
jobs:
  build:
    name: what-sanity
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - uses: actions/setup-python@v2
      - uses: actions/setup-go@v3
        with:
             go-version: '>=1.18.0'
      - run: sudo apt-get update
      - run: sudo apt-get -y install clang llvm libelf-dev gcc-multilib libpcap-dev linux-tools-$(uname -r) elfutils dwarves git libbsd-dev bridge-utils unzip build-essential bison flex iperf iproute2 nodejs socat ethtool
      - run: loxilb-ebpf/utils/mkllb_bpffs.sh
      - run: sudo -E env "PATH=$PATH" make
      - run: docker pull ghcr.io/loxilb-io/loxilb:latest
      - run: docker run -u root --cap-add SYS_ADMIN   --restart unless-stopped --privileged -dit -v /dev/log:/dev/log --name loxilb ghcr.io/loxilb-io/loxilb:latest
      - run: pwd && ls && sudo -E env "PATH=$PATH" make docker-cp
      - run: docker exec -dit loxilb mkllb_bpffs
      - run: id=`docker ps -f name=loxilb | cut  -d " "  -f 1 | grep -iv  "CONTAINER"` && docker commit $id ghcr.io/loxilb-io/loxilb:latest
      - run: docker stop loxilb && docker rm loxilb
      - run: |
             cd cicd/tcplb-local/
             ./config.sh
             ./validation.sh
             ./rmconfig.sh
             cd -
      - name: Dump container logs (files)
        if: failure()
        run: |
          set -euxo pipefail

          CNAME=llb1                 
          LOGDIR=/var/log               
          FIXED_LOG=${LOGDIR}/loxilbdp.log 
          DYN_GLOB="${LOGDIR}/loxilb[0-9a-f]*.log"

          echo "== container status =="
          docker ps -a --filter "name=${CNAME}" --no-trunc

          echo "== loxilb process status =="
          docker exec "${CNAME}" ps ax

          echo "== loxicmd get lb =="
          docker exec "${CNAME}" loxicmd get lb -o wide

          echo "== tc filter show dev lo ingress =="
          docker exec "${CNAME}" tc filter show dev lo ingress

          echo "== dynamic logs: ${DYN_GLOB} =="
          docker exec "${CNAME}" sh -lc "
            set -e
            files=\$(ls -1 ${DYN_GLOB} 2>/dev/null || true)
            if [ -z \"\$files\" ]; then
              echo 'no dynamic logs matched'
              exit 0
            fi
            for f in \$files; do
              echo
              echo '----- BEGIN '\"\$f\"' -----'
              tail -n 2000 \"\$f\" || true
              echo '----- END '\"\$f\"' -----'
            done
          "
